---
title: "p8105_hw3_yz4982"
author: "Yuanyuan Zhang"
output:
  html_document:
    toc: true
    toc_float: true
---

Promblem 1
------------------------------------------------------------
### Short Description
```{r}
library(tidyverse)
library(p8105.datasets)
library(forcats) 

data("instacart")
```

```{r}
n_rows <- nrow(instacart)
n_cols <- ncol(instacart)

n_users       <- n_distinct(instacart$user_id)
n_orders      <- n_distinct(instacart$order_id)
n_products    <- n_distinct(instacart$product_id)
n_aisles      <- n_distinct(instacart$aisle)
n_departments <- n_distinct(instacart$department)

cat(
  "row:", n_rows, 
  "colunm:", n_cols, "\n",
  "numbe of unuique user:", n_users, 
  "number of unique orders:", n_orders, "\n",
  "number of unique products ", n_products, 
  "number of unique aisle:", n_aisles, 
  "number of unique department:", n_departments, "\n"
)

# check variables and type
glimpse(instacart)

# key varibles
set.seed(8105)
instacart |> 
  select(order_id, user_id, product_id, product_name, aisle, department, 
         add_to_cart_order, reordered, order_dow, order_hour_of_day) |>
  slice_sample(n = 5)

```

### Number of Aisles
```{r}
# Counting the number of products ordered per aisle
aisle_counts <- instacart |>
  count(aisle, name = "n_items") |>
  arrange(desc(n_items))

# Total aisle 
n_aisles <- nrow(aisle_counts)
n_aisles

# Top 10 most ordered aisles
top_aisles <- aisle_counts |> slice_max(n_items, n = 10)
top_aisles
```

### Plot The Number of Items Ordered in Each Aisle
```{r}
plot_df <- aisle_counts |>
  filter(n_items > 10000) |>
  mutate(aisle = fct_reorder(aisle, n_items))
plot_df |>
  ggplot(aes(x = n_items, y = aisle)) +
  geom_col() +
  labs(
    title = "Number of items ordered by aisle (> 10,000)",
    x = "Items ordered",
    y = "Aisle"
  )
```

### Table of Top 3 Popular Items in Each of The Aisles 
```{r}
top3_tbl <- instacart |>
  filter(aisle %in% c("baking ingredients",
                      "dog food care",
                      "packaged vegetables fruits")) |>
  count(aisle, product_name, name = "times_ordered", sort = TRUE) |>
  group_by(aisle) |>
  # Take the top 3 products per aisle
  slice_max(times_ordered, n = 3) |>
  # Order by aisle
  arrange(aisle, desc(times_ordered)) |>
  # Assign ranks
  mutate(rank_in_aisle = row_number()) |>
  select(aisle, rank_in_aisle, product_name, times_ordered) |>
  ungroup()

# Print
top3_tbl
```

```{r}
mean_hour_tbl <- instacart |>
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |>
  mutate(
    # Instacart encodes 0=Sunday, ..., 6=Saturday
    dow = factor(order_dow, levels = 0:6,
                 labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat"))
  ) |>
  group_by(product_name, dow) |>
  summarise(mean_hour = mean(order_hour_of_day, na.rm = TRUE), .groups = "drop") |>
  tidyr::pivot_wider(names_from = dow, values_from = mean_hour) |>
  mutate(across(where(is.numeric), ~ round(.x, 2))) |>
  arrange(match(product_name, c("Pink Lady Apples", "Coffee Ice Cream"))) |>
  rename(Product = product_name)

mean_hour_tbl
```



